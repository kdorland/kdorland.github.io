<!doctype html>
<html>
<head>

<!-- Basic Page Needs
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<meta charset="utf-8">
<title>Kristian&#x27;s Homepage</title>
<meta name="description" content="Projects and stuff">
<meta name="author" content="Kristian Dorland">

<!-- FONT
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css" />

<!-- CSS
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/kristian.css">

<!-- Favicon
–––––––––––––––––––––––––––––––––––––––––––––––––– -->
<link rel="icon" type="image/png" href="/images/favicon.png">

</head>
<body>
<div class="container">
<ul id="nav">
    <li style="float:right"><a href="https://dk.linkedin.com/in/kristiandorland">LinkedIn</a></li>
    <li style="float:right"><a href="https://plus.google.com/+KristianDorland">Google+</a>
    <li style="float:right"><a href="https://github.com/kdorland">GitHub</a></li>
</ul>

<h1>Docker and Wordpress - how I do it</h1>
            <time style="display: block">2015-03-31</time>
            <h2 id="so-what-is-docker-">So what is Docker?</h2>
<p>Everyone is using Docker these days for deployment it seems, and I&#39;ve hopped on the bandwagon because Docker is great. If you don&#39;t know what it is, basically it is a wrapper around small virtual linux containers (look up <a href="http://en.wikipedia.org/wiki/LXC">lxc</a> if you want to know more) for running software on your host machine without having to actually install said software. The software runs in it&#39;s own sandbox so it won&#39;t collide with a different version of the same software on the host. Everything is neatly packed into containers, and standard containers are readily available from the official Docker Hub. It&#39;s just like the packages you get from your linux distribution that you install with a simple &quot;apt-get install <em>package name</em>&quot; (or &quot;yum install&quot; or &quot;pacman -S&quot;). It&#39;s just &quot;docker start wordpress&quot; and it&#39;s up and running, and it will automatically download everything you need before it starts. To begin with, that&#39;s all you need to know about Docker.</p>
<h2 id="but-what-does-docker-solve-that-needed-solving-">But what does Docker solve that needed solving?</h2>
<p>So what does Docker provide that we didn&#39;t already have? Let me tell you how I used to do Wordpress hosting whenever I hosted it for someone.</p>
<ul>
<li>First I would find some Linux machine to run it on (which is easy, since I hoard linux VPSs in case I might need one)</li>
<li>Then I would check that the machine has a working Apache (or lighttp) installation ready for use (and install it if it is missing)</li>
<li>Next step would be making an linux user account for the Wordpress installation (and in case the user wants to access it afterwards)</li>
<li>Then download and unpack latest Wordpress distribution</li>
<li>Set up a new virtual host on Apache pointing to the recently unpacked Wordpress installation</li>
<li>Create a new MySQL database (I do most of that stuff through phpmyadmin)</li>
<li>Run the Wordpress install wizard</li>
<li>Hand over the installation to whoever is going to use it</li>
</ul>
<p>I left out the parts about setting up DNS, but that hasn&#39;t changed in any case. </p>
<p>There is nothing wrong about what I just described (I think), but problem is, how do you easily move the Wordpress installation to a new machine without repeating all the steps once more? You guessed it: Docker!</p>
<h2 id="the-solution-docker-">The solution: Docker!</h2>
<p>With Docker, all I need is to spin up two containers for Wordpress and MySQL (actually MariaDB these days), and then a third container for the data. The data can be restored from a backup (which is created daily by a script), and Apache is configured to point at the Wordpress container. Everything should be running after that. Much easier! I tested it. I can restore a Wordpress site on a new machine in less than 5 minutes. It used to take somewhere between 30-60 minutes.</p>
<h2 id="the-details-step-by-step-">The details (step by step)</h2>
<p>There isn&#39;t much to my setup that you won&#39;t find in other tutorials around the net. I made a few changes here and there though, and also included some stuff on how to easily backup stuff and restore it on another machine. I&#39;m not going to pretend that my approach is superior -- I&#39;m still tweaking it as we speak -- but it&#39;s already working quite well.</p>
<p>Basically, this is what I&#39;m going to create:</p>
<ul>
<li>Install Docker</li>
<li>Spin up two containers: one for MariaDB, one for Wordpress</li>
<li>Spin up a third container for the data </li>
<li>Use Apache as a reverse proxy so that Wordpress can be reached from the outside</li>
<li>Make a simple cron job that backups the data once in a while</li>
</ul>
<p>If you want to follow along, you&#39;ll need a Debian 7 machine (Ubuntu might work also, but no guarantees). I recommend creating one at <a href="http://www.digitalocean.com">Digital Ocean</a> since it&#39;s cheap and easy.</p>
<p>Step 1: First you need docker on the machine. For Ubuntu, something like the following will do:</p>
<pre><code>apt-get install docker
</code></pre><p>That also worked on Debian, but gave me an old version. To get up to date, use their install script instead:</p>
<pre><code>curl -sSL https://get.docker.com/ubuntu/ | sudo sh
</code></pre><p>In any case, check their documentation, since the official approach might have changed since last I checked</p>
<p>Step 2: I&#39;ll start with the data container like this:</p>
<pre><code>docker run -d -v /var/lib/mysql -v /var/www/html --name websiteName_vol -e ROOT_PASS=make_up_your_own_password_here tutum/debian
</code></pre><p>I use the tutum/debian docker image since it is very popular and seems to work well. The options are as follows</p>
<pre><code>-d is for running as a daemon
-v is a volume I like to mount. I have several of those as you can see.
--name is a name for my container. In this case: websiteName_vol
-e ROOT_PASS sets an environment variable with that name to the value that follows the equals sign. It&#39;s the root password in case I need it.
</code></pre><p>The volumes are directories that I like to have stored separately from the containers. This means that they are easily backed up and restored if needed, and they don&#39;t die with the containers if I remove them. </p>
<p>The relevant directories stored in this volume are </p>
<pre><code>/var/lib/mysql - this is where all mysql data lives, even the configuration
/var/www/html - Wordpress will live somewhere under here
</code></pre><p>Step 3: This step is optional. If you need to restore data from earlier to the data volume, this is how to do it:</p>
<pre><code>docker run --volumes-from mandalina_vol -v $(pwd)/backup:/backup busybox tar xvf /backup/backup.tar
</code></pre><p>Put your backed up data in a subdirectory named backup: <em>backup/backup.tar</em>. This docker container (image used here is <em>busybox</em>) will untar everything and put it at its right place, meaning that all the directories mentioned in the previous step will all be restored from the backup. More on how to create the backup in step 7.</p>
<p>Step 4: With the data volume ready, next step is to start up the database:</p>
<pre><code>docker run -d -e MARIADB_PASS==make_up_your_own_password_here --name websiteName_mariadb --volumes-from websiteName_vol tutum/mariadb
</code></pre><p>It&#39;s similar to the previous &quot;docker run&quot; command, with a few changes</p>
<pre><code>-d is still there for running as a daemon
-e MARIADB_PASS sets the password for the MySQL root user
--name is used again, this time the name ends with &quot;_mariadb&quot;
--volumes-from is important. It imports volumes from the previous container, and does it by naming it.
</code></pre><p>This time I&#39;m using an image called <em>tutum/mariadb</em>. It&#39;s made by the same guys who made the debian image I used earlier.</p>
<p>Step 5:  I need one more thing before starting up the Wordpress container. I need the IP address of the database container. Many tutorials simply sets up port forwarding so you just have to point at 127.0.0.1:3306 to get to the database, but what if you want to run several database containers on the host? Therefore, I prefer to use the IP of the container. All containers get an IP address of their own which is local to the host machine.</p>
<pre><code>docker inspect websiteName_mariadb | grep IPAddress |cut -d &#39;&quot;&#39; -f 4
</code></pre><p>The above command will give you the IP of the <em>websiteName_mariadb</em> container.</p>
<p>Step 6: Now it&#39;s time for Wordpress. Do the following:</p>
<pre><code>docker run --name websiteName_wordpress --link websiteName_mariadb:mysql -d -e WORDPRESS_DB_PASSWORD=dbPasswordHere -e WORDPRESS_DB_USER=admin -e WORDPRESS_DB_NAME=websiteName_wordpress -e WORDPRESS_DB_HOST=ip_from_before_here --volumes-from websiteName_vol wordpress
</code></pre><p>Yeah, it&#39;s a long one. You need the name of previous containers, the password you have picked, and the IP from step 4. Replace it all and run it, and it should work. The Wordpress container will connect to the database in your database container. It will furthermore import the volumes from your data container, so all your data is isolated and easily backed up. You&#39;ll also notice that I&#39;m using the official Wordpress docker image, nothing third part here, since it seems to work very well as it is.</p>
<p>Step 7: Let me end this by showing you have to make the backup:</p>
<pre><code>docker run --volumes-from websiteName_vol -v $(pwd):/backup ubuntu tar zcvf /backup/backup.tar.gz /var/lib/mysql /var/www/html 
</code></pre><p>This starts a new docker container (once again) using the ubuntu image (for no good reason, feel free to try it with the debian or busybox image instead). It tars and gzips everything from the two directories and put it into a file called <em>backup.tar.gz</em>. That files is put into <em>/backup/</em> in the container, which is linked as a volume into a <em>backup</em> subdirectory on your host. Now you can put the file away somewhere where it will be safe, preferable on another machine, or somewhere in the cloud (Dropbox, S3, or something else you have easy access to).</p>
<p>You can do this automatically from a cron job. I use something similar to the following, but anything simple will do.</p>
<pre><code>#!/bin/sh
NR=$(/bin/date +%V)
docker run --volumes-from websiteName_vol -v /root/backup/:/backup ubuntu tar zcvf /backup/websiteName_backup.${NR}.tar.gz /var/lib/mysql /var/www/html
scp -i /root/.ssh/id_rsa -r /root/backup my_back_host.com:/root/
</code></pre><p>I simply create at new tar.gz where ${NR} is the week number, and upload it somewhere using scp. </p>
<h2 id="using-apache-as-a-reverse-proxy">Using apache as a reverse proxy</h2>
<p>I won&#39;t go into too much detail here since apache is a topic of it&#39;s own. But the following is a rough sketch of how to proxy requests from apache on the host to your wordpress container. </p>
<p>If you use Debian, you can create and enable new virtual hosts by putting their configuration here:</p>
<pre><code>/etc/apache2/sites-available/
</code></pre><p>And enabling them with this command:</p>
<pre><code>a2ensite _config_file_name_
</code></pre><p>A typical config file might look like this:</p>
<pre><code>&lt;VirtualHost *:80&gt;
    ServerName example.com
    ServerAlias www.example.com
    ServerAdmin admin@example.com
    ProxyPass / http://172.17.0.93/
    ProxyPassReverse / http://172.17.0.93/
&lt;/VirtualHost&gt;
</code></pre><p>The IP address used is that of my docker wordpress container.</p>
<h2 id="conclusion-and-ideas-for-improvement">Conclusion and ideas for improvement</h2>
<p>The cron script mentioned was just a quick hack, but everything else is more or less the way I want it. A few things you need to be aware of if you follow my approach:</p>
<ul>
<li>Memory usage seems to be higher with docker images. There are various reasons for this. I&#39;ve been told that different images with different versions of the same libraries is one cause for this, but I haven&#39;t investigated it further.</li>
<li>If you run this setup on a memory restricted server, MySQL might shut down without any errors messages in the stdout. This is not really acceptable, but I seem to a solved this for now on a typical 512 MB host by tuning the apache and mysql configurations, and shutting down unneeded services. I still need to figure out if it would make sense to include some log files in the data volume.</li>
<li>The third container doesn&#39;t actually need to be running, since we only created it for the data volume. You can shut it down with <em>docker stop websiteName_vol</em> without any consequences other than more free memory for the other containers. </li>
</ul>
<p>I&#39;m quite happy with this setup. If you read this far, I hope you got something out of it too. I encourage you two delve into the official documentation if you haven&#39;t already, since there is so much more you can do with Docker. Have fun!</p>
<p>-Kristian</p>

</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61450987-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
